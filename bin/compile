#!/usr/bin/env bash

# fail fast
set -e
BUILD_DIR=$1
CACHE_DIR=$2
APT_DIR="$BUILD_DIR/.apt"
APT_CACHE_DIR="$CACHE_DIR/apt/cache"
APT_STATE_DIR="$CACHE_DIR/apt/state"
APT_OPTIONS="-o debug::nolocking=true -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"
mkdir -p "$APT_CACHE_DIR/archives/partial"
mkdir -p "$APT_STATE_DIR/lists/partial"
mkdir -p "$APT_DIR"


apt-get $APT_OPTIONS update
apt-get $APT_OPTIONS -y --force-yes -d install --reinstall --no-install-recommends libpoppler-glib-dev poppler-utils libwxgtk3.0-gtk3-dev

mkdir -p "$BUILD_DIR/bin/"
cp -a binaries/* "$BUILD_DIR/bin/"

# Setting environment variables in .profile.d script (sourced at dyno startup)
mkdir -p "$BUILD_DIR/.profile.d/"
cat <<EOF >"$BUILD_DIR"/.profile.d/diff-pdf.sh
export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:\$HOME/bin"
EOF

exit 0
